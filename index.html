<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="bootstrap.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="container py-2">
      <img src="Logo.png" class="mb-5" width="300" />
      <div class="w-100 d-flex mb-3">
        <b>PVU Máximo</b>
        <img src="pvu.svg" />
        <input class="form-control mx-3" id="pvu-input" value="50" />
      </div>
      <div class="w-100 d-flex mb-3">
        <b>Producción Mínima</b>
        <img src="le.svg" />
        <input class="form-control mx-3" id="production-input" value="10" />
      </div>

      <button class="btn btn-success" onclick="showPlants()">Buscar</button>
    </header>

    <div class="grid row"></div>

    <script>
      let maximumPrice = 50;
      let minimunProduction = 10;
      const grid = document.querySelector(".grid");

      const token =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwdWJsaWNBZGRyZXNzIjoiMHhmMDA3N2ZjNGMxMGE0NDQ4OGYwNTZjZTg3NmI1MTgwYjdlMmYzOTJjIiwibG9naW5UaW1lIjoxNjMyNDg0OTIyNDA1LCJjcmVhdGVEYXRlIjoiMjAyMS0wOS0xMiAxMzo1Mzo0NCIsImlhdCI6MTYzMjQ4NDkyMn0.p8N_aKdxHthxEcxxkdTHk-N_CialocwmYxEVHj7lPxc";

      const getLastPlants = async () => {
        const res = await fetch(
          "https://backend-farm.plantvsundead.com/get-plants-filter-v2?sort=latest&offset=0&limit=1000",
          {
            headers: {
              authorization: `Bearer Token: ${token}`,
            },
          }
        );

        let { data: plantas } = await res.json();

        plantas = plantas
          .map(({ id, endingPrice, config, iconUrl }) => {
            const {
              farm: { le, hours },
            } = config;
            const production = (le / hours).toFixed(2);
            return {
              id,
              production,
              iconUrl,
              endingPrice,
            };
          })
          .filter(({ endingPrice, config, production }) => {
            return (
              endingPrice <= maximumPrice && production >= minimunProduction
            );
          });
        return plantas;
      };

      const showPlants = async () => {
        const { value: minimunProduction } =
          document.querySelector("#production-input");
        const { value: maximumPrice } = document.querySelector("#pvu-input");
        const plants = await getLastPlants();
        grid.innerHTML = "";
        plants.forEach(({ endingPrice, id, production, iconUrl }) => {
          if (
            endingPrice <= +maximumPrice &&
            production >= +minimunProduction
          ) {
            const url = `https://marketplace.plantvsundead.com/farm#/plant/${id}`;
            grid.innerHTML += `

            <div class="col-12 col-sm-2 py-2">
                <div class="card pt-3">
                    <div style="background-image: url(${iconUrl})" class="img-top"  > </div>
                    <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h5 class="card-title"><img src="pvu.svg" /> ${endingPrice} </h5>
                        <h5 class="card-title"><img src="le.svg" /> ${production} </h5>
                    </div>
                    <a href="${url}" target="_blank" class="btn btn-primary w-100">Ver</a>
                    </div>
                </div>
            </div>

            `;
            console.log(`Price: ${endingPrice} \n Producción: ${production}`);
            console.log(url);
          }
        });
      };
    </script>
  </body>
</html>
