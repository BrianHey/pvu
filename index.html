<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="bootstrap.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="container-fluid py-2">
      <img src="Logo.png" class="mb-5" width="300" />

      <div class="w-100 d-flex mb-3">
        <b>Token</b>
        <img src="token.svg" />
        <input
          class="form-control mx-3"
          id="token-input"
          placeholder="Ingrese aquí su token"
        />
      </div>

      <div class="w-100 d-flex mb-3">
        <b>PVU Máximo</b>
        <img src="pvu.svg" />
        <input class="form-control mx-3" id="pvu-input" value="50" />
      </div>
      <div class="w-100 d-flex mb-3">
        <b>Producción Mínima</b>
        <img src="le.svg" />
        <input class="form-control mx-3" id="production-input" value="10" />
      </div>

      <button class="btn btn-success" onclick="showPlants()">Buscar</button>
    </header>

    <div class="grid row"></div>

    <script>
      let token, maximumPrice, minimunProduction;
      const grid = document.querySelector(".grid");
      const spinner = `<div class="spinner-border text-success mx-auto mt-5" role="status"></div>`;

      const getLastPlants = async () => {
        try {
          grid.innerHTML = spinner;
          const res = await fetch(
            "https://backend-farm.plantvsundead.com/get-plants-filter-v2?sort=latest&offset=0&limit=1000",
            {
              headers: {
                authorization: `Bearer Token: ${token}`,
              },
            }
          );

          let { data: plantas } = await res.json();

          plantas = plantas
            .map(({ id, endingPrice, config, iconUrl }) => {
              const {
                farm: { le, hours },
              } = config;
              const production = (le / hours).toFixed(2);
              return {
                id,
                production,
                iconUrl,
                endingPrice,
              };
            })
            .filter(({ endingPrice, config, production }) => {
              return (
                endingPrice <= maximumPrice && production >= minimunProduction
              );
            })
            .sort((a, b) => {
              const { endingPrice: endingPriceA, production: productionA } = a;
              const { endingPrice: endingPriceB, production: productionB } = b;
              return endingPriceA - endingPriceB;
            });
          return plantas;
        } catch (e) {
          grid.innerHTML;
          alert("Algo salió mal... Asegúrate de haber copiado bien el token");
        }
      };

      const showPlants = async () => {
        const { value: maximumPriceInput } =
          document.querySelector("#pvu-input");
        maximumPrice = maximumPriceInput;
        const { value: minimunProductionInput } =
          document.querySelector("#production-input");
        minimunProduction = minimunProductionInput;
        const { value: tokenInput } = document.querySelector("#token-input");
        token = tokenInput;

        const plants = await getLastPlants();
        grid.innerHTML = "";
        plants.forEach(({ endingPrice, id, production, iconUrl }) => {
          if (
            endingPrice <= +maximumPrice &&
            production >= +minimunProduction
          ) {
            const url = `https://marketplace.plantvsundead.com/farm#/plant/${id}`;
            grid.innerHTML += `

            <div class="col-12 col-sm-6 col-md-4 col-lg-3  py-2">
                <div class="card pt-3">
                    <div style="background-image: url(${iconUrl})" class="img-top"  > </div>
                    <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h5 class="card-title"><img src="pvu.svg" /> ${endingPrice} </h5>
                        <h5 class="card-title"><img src="le.svg" /> ${production} </h5>
                    </div>
                    <a href="${url}" target="_blank" class="btn w-100">Ver</a>
                    </div>
                </div>
            </div>

            `;
            console.log("alo");
          }
        });
      };
    </script>
  </body>
</html>
